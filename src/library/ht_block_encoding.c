/*================================================================================================*\
||                                                                                                ||
||       /$$$$$$$  /$$                  /$$      /$$ /$$                                          ||
||      | $$__  $$|__/                 | $$  /$ | $$| $$                                          ||
||      | $$  \ $$ /$$  /$$$$$$        | $$ /$$$| $$| $$$$$$$   /$$$$$$   /$$$$$$   /$$$$$$       ||
||      | $$$$$$$ | $$ /$$__  $$       | $$/$$ $$ $$| $$__  $$ /$$__  $$ /$$__  $$ /$$__  $$      ||
||      | $$__  $$| $$| $$  \ $$       | $$$$_  $$$$| $$  \ $$| $$  \ $$| $$  \ $$| $$  \ $$      ||
||      | $$  \ $$| $$| $$  | $$       | $$$/ \  $$$| $$  | $$| $$  | $$| $$  | $$| $$  | $$      ||
||      | $$$$$$$/| $$|  $$$$$$$       | $$/   \  $$| $$  | $$|  $$$$$$/|  $$$$$$/| $$$$$$$/      ||
||      |_______/ |__/ \____  $$       |__/     \__/|__/  |__/ \______/  \______/ | $$____/       ||
||                     /$$  \ $$                                                  | $$            ||
||                    |  $$$$$$/                                                  | $$            ||
||                     \______/                                                   |__/            ||
||                                                                                                ||
||  DESCRIPTION:                                                                                  ||
||  ------------                                                                                  ||
||                                                                                                ||
||        DESCRIPTION NEEDED.                                                                     ||
||       |                                                                                |       ||
||                                                                                                ||
||  --------------------------------------------------------------------------------------------  ||
||  Copyright (c) 2023, High Performance Computing Center - University of Stuttgart               ||
||                                                                                                ||
||  Redistribution and use in source and binary forms, with or without modification, are          ||
||  permitted provided that the following conditions are met:                                     ||
||                                                                                                ||
||     (1)   Redistributions of source code must retain the above copyright notice, this list of  ||
||           conditions and the following disclaimer.                                             ||
||                                                                                                ||
||     (2)   Redistributions in binary form must reproduce the above copyright notice, this list  ||
||           of conditions and the following disclaimer in the documentation and/or other         ||
||           materials provided with the distribution.                                            ||
||                                                                                                ||
||  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS “AS IS” AND ANY EXPRESS   ||
||  OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF               ||
||  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE    ||
||  COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,     ||
||  EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF            ||
||  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)        ||
||  HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR      ||
||  TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,  ||
||  EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                                            ||
||                                                                                                ||
\*================================================================================================*/
/**************************************************************************************************\
||                                _ _  _ ____ _    _  _ ___  ____                                 ||
||                                | |\ | |    |    |  | |  \ |___                                 ||
||                                | | \| |___ |___ |__| |__/ |___                                 ||
||                                                                                                ||
\**************************************************************************************************/
#include <assert.h>
#include <stdlib.h>
#include <math.h>

#include "types.h"
#include "ht_block_encoding.h"

/**************************************************************************************************\
||      ____ _  _ ___ ____ ____ _  _ ____ _       _  _ ____ ____ _ ____ ___  _    ____ ____       ||
||      |___  \/   |  |___ |__/ |\ | |__| |       |  | |__| |__/ | |__| |__] |    |___ [__        ||
||      |___ _/\_  |  |___ |  \ | \| |  | |___     \/  |  | |  \ | |  | |__] |___ |___ ___]       ||
||                                                                                                ||
\**************************************************************************************************/
/**************************************************************************************************\
||      ____ _  _ ___ ____ ____ _  _ ____ _       ____ ____ _  _ ____ ___ ____ _  _ ___ ____      ||
||      |___  \/   |  |___ |__/ |\ | |__| |       |    |  | |\ | [__   |  |__| |\ |  |  [__       ||
||      |___ _/\_  |  |___ |  \ | \| |  | |___    |___ |__| | \| ___]  |  |  | | \|  |  ___]      ||
||                                                                                                ||
\**************************************************************************************************/
/**************************************************************************************************\
||          ____ _    ____ ___  ____ _       ____ ____ _  _ ____ ___ ____ _  _ ___ ____           ||
||          | __ |    |  | |__] |__| |       |    |  | |\ | [__   |  |__| |\ |  |  [__            ||
||          |__] |___ |__| |__] |  | |___    |___ |__| | \| ___]  |  |  | | \|  |  ___]           ||
||                                                                                                ||
\**************************************************************************************************/
/**************************************************************************************************\
||           ___  ____ _ _  _ ____ ___ ____    ____ _  _ _  _ ____ ___ _ ____ _  _ ____           ||
||           |__] |__/ | |  | |__|  |  |___    |___ |  | |\ | |     |  | |  | |\ | [__            ||
||           |    |  \ |  \/  |  |  |  |___    |    |__| | \| |___  |  | |__| | \| ___]           ||
||                                                                                                ||
\**************************************************************************************************/
static void
quantize(ht_bwc_codeblock *const destination, bwc_sample *const source,
         bwc_cblk_access  *const cblkaccess,              const uint64 width,
                           const uint64 height,           const uint64 depth)
{
   /*-----------------------*\
   ! DEFINE INT VARIABLES:   !
   \*-----------------------*/
   bwc_raw  buff, sign_mask;
   uint64   bit_mask, limit;
   uint64   cblk_width, cblk_height, cblk_depth, cblk_dt, cblk_stripe;
   uint64   incrX, incrY, incrZ;
   uint64   i, x, y, z, t;
   uint64   X0, Y0, Z0, TS0;
   uint64   X1, Y1, Z1, TS1;
   int64    idx_u, idx_r, idx_d, idx_l;
   uint8    b, Kmax, s;

   /*-----------------------*\
   ! DEFINE FLOAT VARIABLES: !
   \*-----------------------*/
   bwc_float   qt_step_size;

   /*-----------------------*\
   ! DEFINE STRUCTS:         !
   \*-----------------------*/
   bwc_cblk_inf       *cblk_info;
   bwc_sample         *tmp;

   /*-----------------------*\
   ! DEFINE ASSERTIONS:      !
   \*-----------------------*/
   assert(destination);
   assert(cblkaccess);
   assert(source);

   /*--------------------------------------------------------*\
   ! Save the codeblock info structure to a temporary varia-  !
   ! ble to make the code more readable.                      !
   \*--------------------------------------------------------*/
   cblk_info = &cblkaccess->codeblock->info;

   /*--------------------------------------------------------*\
   ! Setup a bitmask to access the sign bit position.         !
   \*--------------------------------------------------------*/
   sign_mask    = ~((bwc_raw)0x01 << PREC_BIT);

   /*--------------------------------------------------------*\
   ! Initialize the quantization step size and the index of   !
   ! the most significant bitfield.                           !
   \*--------------------------------------------------------*/
   qt_step_size = cblkaccess->subband->control.qt_effective_step_size;
   Kmax         = 0;

   /*--------------------------------------------------------*\
   ! Save the codeblock dimensions to temporary variables to  !
   ! make the code more readable.                             !
   \*--------------------------------------------------------*/
   X0  = cblk_info->X0;
   Y0  = cblk_info->Y0;
   Z0  = cblk_info->Z0;
   TS0 = cblk_info->TS0;

   X1  = cblk_info->X1;
   Y1  = cblk_info->Y1;
   Z1  = cblk_info->Z1;
   TS1 = cblk_info->TS1;

   /*--------------------------------------------------------*\
   ! Calculate the width, height, depth and dt of the code-   !
   ! block to be copied.                                      !
   \*--------------------------------------------------------*/
   cblk_width  = X1 - X0;
   cblk_height = Y1 - Y0;
   cblk_depth  = Z1 - Z0;
   cblk_dt     = TS1 - TS0;

   /*--------------------------------------------------------*\
   ! Calculate the number of stripes that are to be copied.   !
   ! In case the number of rows is not divisible by 8, the    !
   ! number of stripes is rounded up to the nearest integer.  !
   \*--------------------------------------------------------*/
   cblk_stripe = ceil((double)cblk_height/4);

   /*--------------------------------------------------------*\
   ! Calculate the pointer increments used to loop through    !
   ! the source memory.                                       !
   \*--------------------------------------------------------*/
   incrX = width;
   incrY = width * (height - (Y1 - Y0));
   incrZ = width * height * (depth - (Z1 - Z0));

   /*--------------------------------------------------------*\
   ! Associate the temporary pointer to the starting points   !
   ! of the source memory.                                    !
   \*--------------------------------------------------------*/
   tmp = &source[X0 + width * (Y0 + height * (Z0 + depth * TS0))];
   destination->samples = calloc(cblk_width * cblk_height *
                                 cblk_depth * cblk_dt, sizeof(bwc_raw));

   /*--------------------------------------------------------*\
   ! Walk through all wavelet coefficients in the current     !
   ! codeblock in a stripe pattern and save the sign and      !
   ! significant magnitude bits in the bwc_coder_stripe       !
   ! structure. Here, two adjacent stripes are stored         !
   ! in one 8 bit integer.                                    !
   \*--------------------------------------------------------*/
   for(t = 0, i = 0; t < cblk_dt; ++t)
   {
      for(z = 0; z < cblk_depth; ++z)
      {
         for(y = 0; y < cblk_stripe; i += cblk_width, ++y)
         {
            /*--------------------------------------------------------*\
            ! Initialize the stripe bit masks to the first stripe posi-!
            ! tion in the sign, state and sample variables.            !
            \*--------------------------------------------------------*/
            bit_mask = 0x08;

            for(s = 0, limit = cblk_height - y * 4; s < 4 && s < limit; ++s)
            {
               for(x = 0; x < cblk_width; ++x)
               {
                  /*--------------------------------------------------------*\
                  ! Save the sign bit of the current wavelet coefficient in  !
                  ! the appropriate position of the sign field.              !
                  \*--------------------------------------------------------*/
                  destination[x + i].xi |= bit_mask * (tmp[x].raw / ~sign_mask);

                  /*--------------------------------------------------------*\
                  ! Calculate the absolute value of the wavelet coefficient  !
                  ! and store the quantized value in the temporary buffer.   !
                  \*--------------------------------------------------------*/
                  tmp[x].raw &= sign_mask;
                  buff        = (bwc_raw)(tmp[x].f / qt_step_size);

                  /*--------------------------------------------------------*\
                  ! Save the unsigned wavelet coefficient for distortion     !
                  ! calculation.                                             !
                  \*--------------------------------------------------------*/
                  destination[x + i].sample[3 - s] = buff;

                  /*--------------------------------------------------------*\
                  ! set the bitfield index b to zero.                        !
                  \*--------------------------------------------------------*/
                  b = 0;

                  /*--------------------------------------------------------*\
                  ! Save the significant bits of the current wavelet coeffi- !
                  ! cient in the appropriate bitfield and stripe.            !
                  \*--------------------------------------------------------*/
                  while(buff)
                  {
                     destination[x + i].bit[b] |= bit_mask * (buff & 0x01);
                     buff >>= 1;
                     b++;
                  }

                  /*--------------------------------------------------------*\
                  ! Update the index of the most significant bitfield.       !
                  \*--------------------------------------------------------*/
                  Kmax = MAX(Kmax, b);

                  /*--------------------------------------------------------*\
                  ! Evaluate the appropriate index for the stripe neighbours !
                  ! Neighbours that fall outside of the codeblock boundaries !
                  ! are set to dummy variables to uncouple the current block !
                  ! from its neighbors.                                      !
                  \*--------------------------------------------------------*/
                  idx_u = (y == 0)              ? -1 : (int64)(i + x - cblk_width);
                  idx_r = (x == cblk_width - 1) ? -2 : (int64)(i + x + 1);
                  idx_d = (s == limit - 1)      ? -1 : (int64)(i + x + cblk_width);
                  idx_l = (x == 0)              ? -2 : (int64)(i + x - 1);

                  /*--------------------------------------------------------*\
                  ! Set the state pointers.                                  !
                  \*--------------------------------------------------------*/
                  destination[x + i].stripe_u = &destination[idx_u];
                  destination[x + i].stripe_r = &destination[idx_r];
                  destination[x + i].stripe_d = &destination[idx_d];
                  destination[x + i].stripe_l = &destination[idx_l];
               }
               /*--------------------------------------------------------*\
               ! Increment the stripe bit mask to the next stripe posi-   !
               ! tion slice and increment the temporary data pointer to   !
               ! the next row.                                            !
               \*--------------------------------------------------------*/
               bit_mask >>= 1;
               tmp       += incrX;
            }
         }
         /*--------------------------------------------------------*\
         ! Increment to the next column.                            !
         \*--------------------------------------------------------*/
         tmp += incrY;
      }
      /*--------------------------------------------------------*\
      ! Increment to the next spatial slice.                     !
      \*--------------------------------------------------------*/
      tmp += incrZ;
   }
   /*--------------------------------------------------------*\
   ! Save the most significant bitfield of the current sub-   !
   ! band in the appropriate subband structure.               !
   \*--------------------------------------------------------*/
   cblkaccess->codeblock->control.K = Kmax;
}
/**************************************************************************************************\
||             ___  _  _ ___  _    _ ____    ____ _  _ _  _ ____ ___ _ ____ _  _ ____             ||
||             |__] |  | |__] |    | |       |___ |  | |\ | |     |  | |  | |\ | [__              ||
||             |    |__| |__] |___ | |___    |    |__| | \| |___  |  | |__| | \| ___]             ||
||                                                                                                ||
\**************************************************************************************************/
/*------------------------------------------------------------------------------------------------*\
!                                                                                                  !
!   DESCRIPTION:                                                                                   !
!   ------------                                                                                   !
!                                                                                                  !
!         DESCRIPTION NEEDED                                                                       !
!        |                                                                                |        !
!                                                                                                  !
!   RETURN:                                                                                        !
!   -------                                                                                        !
!                                                                                                  !
!         -                                                                                        !
!                                                                                                  !
\*------------------------------------------------------------------------------------------------*/
/*-----------------------*\
! DEFINE INT VARIABLES:   !
\*-----------------------*/
/*-----------------------*\
! DEFINE FLOAT VARIABLES: !
\*-----------------------*/
/*-----------------------*\
! DEFINE CHAR VARIABLES:  !
\*-----------------------*/
/*-----------------------*\
! DEFINE STRUCTS:         !
\*-----------------------*/
/*--------------------------------------------------------*\
! COMMENTCOMMENTCOMMENTCOMMENTCOMMENTCOMMENTCOMMENTCOMMENT !
\*--------------------------------------------------------*/
#ifndef HEADER_H
#define HEADER_H
  /************************************************************************************************\
  ||                               _ _  _ ____ _    _  _ ___  ____                                ||
  ||                               | |\ | |    |    |  | |  \ |___                                ||
  ||                               | | \| |___ |___ |__| |__/ |___                                ||
  ||                                                                                              ||
  \************************************************************************************************/
  /************************************************************************************************\
  ||                ___  ____ _ _  _ _ ___ _ _  _ ____    ___ _   _ ___  ____ ____                ||
  ||                |__] |__/ | |\/| |  |  | |  | |___     |   \_/  |__] |___ [__                 ||
  ||                |    |  \ | |  | |  |  |  \/  |___     |    |   |    |___ ___]                ||
  ||                                                                                              ||
  \************************************************************************************************/
  /************************************************************************************************\
  ||                                _  _ ____ ____ ____ ____ ____                                 ||
  ||                                |\/| |__| |    |__/ |  | [__                                  ||
  ||                                |  | |  | |___ |  \ |__| ___]                                 ||
  ||                                                                                              ||
  \************************************************************************************************/
  /************************************************************************************************\
  ||                          ____ ____ _  _ ____ ___ ____ _  _ ___ ____                          ||
  ||                          |    |  | |\ | [__   |  |__| |\ |  |  [__                           ||
  ||                          |___ |__| | \| ___]  |  |  | | \|  |  ___]                          ||
  ||                                                                                              ||
  \************************************************************************************************/
  /************************************************************************************************\
  ||     ____ _  _ ___ ____ ____ _  _ ____ _       _  _ ____ ____ _ ____ ___  _    ____ ____      ||
  ||     |___  \/   |  |___ |__/ |\ | |__| |       |  | |__| |__/ | |__| |__] |    |___ [__       ||
  ||     |___ _/\_  |  |___ |  \ | \| |  | |___     \/  |  | |  \ | |  | |__] |___ |___ ___]      ||
  ||                                                                                              ||
  \************************************************************************************************/
  /************************************************************************************************\
  ||     ____ _  _ ___ ____ ____ _  _ ____ _       ____ ____ _  _ ____ ___ ____ _  _ ___ ____     ||
  ||     |___  \/   |  |___ |__/ |\ | |__| |       |    |  | |\ | [__   |  |__| |\ |  |  [__      ||
  ||     |___ _/\_  |  |___ |  \ | \| |  | |___    |___ |__| | \| ___]  |  |  | | \|  |  ___]     ||
  ||                                                                                              ||
  \************************************************************************************************/
  /************************************************************************************************\
  ||                                   ___ _   _ ___  ____ ____                                   ||
  ||                                    |   \_/  |__] |___ [__                                    ||
  ||                                    |    |   |    |___ ___]                                   ||
  ||                                                                                              ||
  \************************************************************************************************/
  /************************************************************************************************\
  ||               ___  ____ ____ ____ _ _  _ ____ ___     ___ _   _ ___  ____ ____               ||
  ||               |  \ |___ |__/ |__/ | |  | |___ |  \     |   \_/  |__] |___ [__                ||
  ||               |__/ |___ |  \ |  \ |  \/  |___ |__/     |    |   |    |___ ___]               ||
  ||                                                                                              ||
  \************************************************************************************************/
  /*----------------------------------------------------------------------------------------------*\
  !                                                                                                !
  !   DESCRIPTION:                                                                                 !
  !   ------------                                                                                 !
  !                                                                                                !
  !         DESCRIPTION NEEDED                                                                     !
  !        |                                                                              |        !
  !                                                                                                !
  \*----------------------------------------------------------------------------------------------*/
  //===========================|=========================|==========================================
  /************************************************************************************************\
  ||            ___  _  _ ___  _    _ ____    ____ _  _ _  _ ____ ___ _ ____ _  _ ____            ||
  ||            |__] |  | |__] |    | |       |___ |  | |\ | |     |  | |  | |\ | [__             ||
  ||            |    |__| |__] |___ | |___    |    |__| | \| |___  |  | |__| | \| ___]            ||
  ||                                                                                              ||
  \************************************************************************************************/
  //==========|==========================|======================|======|=======|====================
  //================================================================================================
#endif